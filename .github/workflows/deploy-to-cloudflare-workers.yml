on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up environment variables
        run: |
          echo "COMMIT_HASH_FULL=$(git rev-parse HEAD)" >> $GITHUB_ENV
          echo "COMMIT_HASH_SHORT=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Print commit hashes
        run: |
          echo "Full commit hash: $COMMIT_HASH_FULL"
          echo "Short commit hash: $COMMIT_HASH_SHORT"

      - name: Set up pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler CLI
        run: npm install -g wrangler

      - name: Install dependencies
        run: pnpm install

      - name: Migrate
        run: pnpm db:migrate
        env:
          POSTGRES_URL: ${{ secrets.POSTGRES_URL }}

      - name: Deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          preCommands: |
            echo "*** update last commit variables ***"
            echo "${{ env.COMMIT_HASH_FULL }}" | wrangler secret put LAST_COMMIT
            echo "${{ env.COMMIT_HASH_SHORT }}" | wrangler secret put LAST_COMMIT_SHORT
            echo "******"

      - name: Set Deployment ID
        id: get_deployment_id
        run: |
          CF_DEPLOYMENT_ID=$(curl -s -X GET "https://api.cloudflare.com/client/v4/accounts/{account_id}/workers/scripts/{script_name}/deployments" \
          -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
          | jq -r '.result.deployments[0].id')
          echo "CF_DEPLOYMENT_ID=$CF_DEPLOYMENT_ID" >> $GITHUB_ENV
          echo "${{ env.CF_DEPLOYMENT_ID }}" | wrangler secret put CF_DEPLOYMENT_ID
